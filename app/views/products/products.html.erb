<h1>Our Products</h1>

<div class="products-grid">
  <% @products.each do |product| %>
    <div class="product-card">
      <img src="<%= product.productImage %>" alt="<%= product.productName %>" />
      <h3><%= product.productName %></h3>
      <h4>Category: <%= product.productCategory %></h4>
      <p>KSh <%= product.productPrice %></p>
      <button class="view-item-btn"
        data-id="<%= product.id.to_s %>"
        data-name="<%= product.productName %>"
        data-category="<%= product.productCategory %>"
        data-description="<%= product.productDescription %>"
        data-price="<%= product.productPrice %>"
        data-image="<%= product.productImage %>">
        View Item
      </button>
    </div>
  <% end %>
</div>

<!-- Product Modal -->
<div id="productModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div class="modal-body">
      <div class="modal-image">
        <img id="modalProductImage" src="" alt="Product image" />
      </div>

      <div class="modal-details">
        <h2 id="modalProductName"></h2>
        <p><strong>Category:</strong> <span id="modalProductCategory"></span></p>
        <p id="modalProductDescription"></p>
        <p><strong>Price:</strong> KSh <span id="modalProductPrice"></span></p>
        <div class="quantity-box">
          <label for="quantityInput">Quantity:</label>
          <input type="number" id="quantityInput" value="1" min="1" />
        </div>
        <div class="cart-actions">
          <button id="addToCartBtn" class="add-to-cart-btn">Add to Cart</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .products-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
  }

  .product-card {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }

  .product-card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .view-item-btn {
    margin-top: 10px;
    background-color: #5a00cc;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 10;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5);
  }

  .modal-content {
    background: white;
    margin: 5% auto;
    padding: 20px;
    border-radius: 10px;
    width: 60%;
    max-width: 800px;
  }

  .modal-body {
    display: flex;
    gap: 20px;
  }

  .modal-image img {
    width: 300px;
    height: 300px;
    object-fit: cover;
    border-radius: 8px;
  }

  .modal-details {
    flex: 1;
  }

  .close {
    float: right;
    font-size: 1.5em;
    cursor: pointer;
  }

  .add-to-cart-btn {
  margin-top: 15px;
  background-color: #28a745;
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  }

  .add-to-cart-btn:hover {
    background-color: #218838;
  }

</style>

<script>
  document.querySelectorAll(".view-item-btn").forEach(button => {
    button.addEventListener("click", () => {
      document.getElementById("productModal").style.display = "block";
      document.getElementById("modalProductName").textContent = button.dataset.name;
      document.getElementById("modalProductCategory").textContent = button.dataset.category;
      document.getElementById("modalProductDescription").textContent = button.dataset.description;
      document.getElementById("modalProductPrice").textContent = button.dataset.price;
      document.getElementById("modalProductImage").src = button.dataset.image;
    });
  });

  document.querySelector(".close").addEventListener("click", () => {
    document.getElementById("productModal").style.display = "none";
  });

  window.addEventListener("click", (event) => {
    if (event.target === document.getElementById("productModal")) {
      document.getElementById("productModal").style.display = "none";
    }
  });

  // Store the currently selected product ID (weâ€™ll add this to your View Item button later)
let currentProductId = null;

// Update modal logic to capture product ID too
document.querySelectorAll(".view-item-btn").forEach(button => {
  button.addEventListener("click", () => {
    document.getElementById("productModal").style.display = "block";
    document.getElementById("modalProductName").textContent = button.dataset.name;
    document.getElementById("modalProductCategory").textContent = button.dataset.category;
    document.getElementById("modalProductDescription").textContent = button.dataset.description;
    document.getElementById("modalProductPrice").textContent = button.dataset.price;
    document.getElementById("modalProductImage").src = button.dataset.image;

    currentProductId = button.dataset.id; // store product ID
  });
});

// Add to Cart logic
document.getElementById("addToCartBtn").addEventListener("click", async () => {
  const quantity = parseInt(document.getElementById("quantityInput").value);

  if (!currentProductId) {
    alert("Error: No product selected.");
    return;
  }

  const response = await fetch("/cart/add_item", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      product_id: currentProductId,
      quantity: quantity
    }),
  });

  const data = await response.json();

  if (response.ok) {
    alert("Item added to cart!");
    document.getElementById("productModal").style.display = "none";
  } else {
    alert(`Error: ${data.error || "Could not add item."}`);
  }
});

</script>
