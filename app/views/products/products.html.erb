<h1 style="text-align:center; color:#1a73e8; margin-top:22px; font-family:Arial, sans-serif;">
Our Products
</h1>

<div class="products-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:20px; margin-top:18px; padding: 0 16px;">
  <% @products.each do |product| %>
    <div class="product-card" style="border:1px solid #e3e3e3; border-radius:8px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.06); display:flex; flex-direction:column; align-items:stretch; justify-content:space-between;">
      <div style="flex: 0 0 auto;">
      <div style="height:200px; overflow:hidden; border-radius:6px; display:flex; align-items:center; justify-content:center; background:#fafafa; margin-bottom:10px;">
      <img src="<%= product.productImage %>" alt="<%= product.productName %>" style="max-width:100%; max-height:100%; object-fit:cover;" />
      </div>

      <h3 style="font-size:1rem; margin:6px 0 4px; color:#111; font-weight:700;"><%= product.productName %></h3>
      <h4 style="margin:0 0 8px; font-size:0.9rem; color:#6c757d; font-weight:600;">Category: <span style="color:#444; font-weight:600;"><%= product.productCategory %></span></h4>
      <p style="margin:0 0 12px; font-weight:800; color:#007bff;">KSh <%= product.productPrice %></p>
      </div>

      <div style ="flex:0 0 auto; display:flex; gap:8px; justify-content:center; margin-top:12px;">
      <button class="view-item-btn"
        data-id="<%= product.id.to_s %>"
        data-name="<%= product.productName %>"
        data-category="<%= product.productCategory %>"
        data-description="<%= product.productDescription %>"
        data-price="<%= product.productPrice %>"
        data-image="<%= product.productImage %>"
        style="background-color:#5a00cc; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:600;">
        View Item
      </button>
    </div>
  </div>
  <% end %>
</div>

<!-- Product Modal -->
<div id="productModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.55); align-items:center; justify-content:center; padding:20px;">
  <div class="modal-content" style="background:#ffffff; border-radius:10px; width:100%; max-width:900px; padding:18px; box-shadow:0 12px 40px rgba(2,6,23,0.25);">
    <span class="close" style="float:right; font-size:1.4rem; cursor:pointer; color:#333; line-height:1;">&times;</span>

    <div class="modal-body" style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start;">
      <div class="modal-image"  style="flex:0 0 320px; display:flex; align-items:center; justify-content:center; background:#fafafa; padding:8px; border-radius:8px;">
        <img id="modalProductImage" src="" alt="Product image" style="width:300px; height:300px; object-fit:cover; border-radius:6px;">
      </div>

      <div class="modal-details" style="flex:1 1 300px;">
        <h2 id="modalProductName" style="margin:0 0 8px; font-size:1.3rem; color:#111;"></h2>
        <p style="margin:6px 0;"><strong>Category:</strong> <span id="modalProductCategory"  style="color:#444; font-weight:600;"></span></p>
        <p id="modalProductDescription" style="margin:10px 0; color:#555;"></p>
        <p style="margin:8px 0;"><strong>Price:</strong> <span style="font-weight:800; color:#007bff;">KSh <span id="modalProductPrice"></span></span></p>

        <div class="quantity-box" style="margin-top:12px; display:flex; gap:8px; align-items:center;">
          <label for="quantityInput" style="font-weight:600; color:#333;">Quantity:</label>
          <input type="number" id="quantityInput" value="1" min="1"  style="width:80px; padding:8px; border-radius:6px; border:1px solid #ddd;" />
        </div>

        <div class="cart-actions" style="margin-top:18px;">
          <button id="addToCartBtn" class="add-to-cart-btn" class="add-to-cart-btn" style="background-color:#28a745; color:white; border:none; padding:10px 15px; border-radius:6px; cursor:pointer; font-weight:700;">
          Add to Cart
          </button>
        </div>
      </div>
    </div>
  </div>
</div>



<script>
  document.querySelectorAll(".view-item-btn").forEach(button => {
    button.addEventListener("click", () => {
      document.getElementById("productModal").style.display = "block";
      document.getElementById("modalProductName").textContent = button.dataset.name;
      document.getElementById("modalProductCategory").textContent = button.dataset.category;
      document.getElementById("modalProductDescription").textContent = button.dataset.description;
      document.getElementById("modalProductPrice").textContent = button.dataset.price;
      document.getElementById("modalProductImage").src = button.dataset.image;
    });
  });

  document.querySelector(".close").addEventListener("click", () => {
    document.getElementById("productModal").style.display = "none";
  });

  window.addEventListener("click", (event) => {
    if (event.target === document.getElementById("productModal")) {
      document.getElementById("productModal").style.display = "none";
    }
  });

  // Store the currently selected product ID (weâ€™ll add this to your View Item button later)
let currentProductId = null;

// Update modal logic to capture product ID too
document.querySelectorAll(".view-item-btn").forEach(button => {
  button.addEventListener("click", () => {
    document.getElementById("productModal").style.display = "block";
    document.getElementById("modalProductName").textContent = button.dataset.name;
    document.getElementById("modalProductCategory").textContent = button.dataset.category;
    document.getElementById("modalProductDescription").textContent = button.dataset.description;
    document.getElementById("modalProductPrice").textContent = button.dataset.price;
    document.getElementById("modalProductImage").src = button.dataset.image;

    currentProductId = button.dataset.id; // store product ID
  });
});

// Add to Cart logic
document.getElementById("addToCartBtn").addEventListener("click", async () => {
  const quantity = parseInt(document.getElementById("quantityInput").value);

  if (!currentProductId) {
    alert("Error: No product selected.");
    return;
  }

  const response = await fetch("/cart/add_item", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      product_id: currentProductId,
      quantity: quantity
    }),
  });

  const data = await response.json();

  if (response.ok) {
    alert("Item added to cart!");
    document.getElementById("productModal").style.display = "none";
  } else {
    alert(`Error: ${data.error || "Could not add item."}`);
  }
});

</script>
